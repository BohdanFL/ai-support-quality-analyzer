services:
    # Ollama сервіс
    ollama:
        image: ollama/ollama:latest
        container_name: ollama-server
        profiles:
            - with-ollama
        volumes:
            - ollama_models:/root/.ollama
        ports:
            - "11434:11434" # Порт для Ollama API
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "ollama", "--version"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - support-network

    # Сервіс для завантаження моделі (опціонально)
    ollama-setup:
        image: ollama/ollama:latest
        profiles:
            - with-ollama
        depends_on:
            ollama:
                condition: service_healthy
        volumes:
            - ollama_models:/root/.ollama
        environment:
            - OLLAMA_MODEL=${OLLAMA_MODEL:-llama2}
        entrypoint: ["/bin/sh", "-c"]
        command: >
            "
            echo '⏳ Завантаження моделі $OLLAMA_MODEL...' &&
            ollama pull $OLLAMA_MODEL &&
            echo '✅ Модель $OLLAMA_MODEL завантажена!'
            "
        networks:
            - support-network

    # Головний додаток - тільки bash, без автоматичного запуску
    llm_app:
        build: .
        container_name: llm_analytics
        profiles:
            - with-ollama
            - without-ollama
        depends_on:
            ollama:
                condition: service_healthy
                required: false
        env_file:
            - .env
        ports:
            - "8501:8501" # Порт для Streamlit (ти будеш запускати вручну)
        volumes:
            - ./output:/app/output
            - .:/app
        stdin_open: true
        tty: true
        environment:
            - OLLAMA_HOST=http://ollama:11434
            - OLLAMA_MODEL=${OLLAMA_MODEL:-llama2}
        networks:
            - support-network
        command: /bin/bash # Просто запускає bash, нічого більше

volumes:
    ollama_models:

networks:
    support-network:
        driver: bridge
